<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµ¬ë¦„ë°˜ ë§ˆë‹ˆë˜ ê²Œì„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        .card-bg { background-color: #f7f9fb; background-image: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .invitation-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .btn-gradient { background-image: linear-gradient(to right, #667eea 0%, #764ba2 51%, #667eea 100%); transition: 0.5s; background-size: 200% auto; }
        .btn-gradient:hover { background-position: right center; }
    </style>
</head>
<body class="card-bg flex items-center justify-center min-h-screen">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-3xl">
        <div class="invitation-card p-6 sm:p-8 rounded-2xl shadow-2xl">
            
            <div class="text-center mb-8">
                <h2 class="font-playfair text-gray-500 text-xl">4í•™ë…„ 6ë°˜ êµ¬ë¦„ë°˜</h2>
                <h1 class="font-playfair text-5xl font-bold text-gray-800 mt-2">ğŸŒŸ ë¹„ë°€ ë§ˆë‹ˆë˜ ê²Œì„ ğŸŒŸ</h1>
                <p class="text-gray-600 mt-4">ì¹œêµ¬ë“¤ì˜ ë§ˆë‹ˆë˜ê°€ ë˜ì–´ ë¹„ë°€ ì„ ë¬¼ì„ ì¤€ë¹„í•´ ë³¼ê¹Œìš”?</p>
            </div>

            <!-- ë¡œê·¸ì¸/íšŒì›ê°€ì… ì„¹ì…˜ -->
            <div id="auth-section" class="mb-8 p-6 bg-blue-50 rounded-lg shadow-inner border border-blue-200">
                <h3 class="text-2xl font-bold text-blue-700 text-center mb-5 font-playfair">ë¡œê·¸ì¸ / íšŒì›ê°€ì…</h3>
                <div class="space-y-4 max-w-sm mx-auto">
                    <div>
                        <label for="name-input" class="block text-sm font-medium text-gray-700">ì´ë¦„ (ë‹‰ë„¤ì„)</label>
                        <input type="text" id="name-input" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="ì˜ˆ: ê¹€êµ¬ë¦„">
                    </div>
                    <div>
                        <label for="password-input" class="block text-sm font-medium text-gray-700">ë¹„ë°€ë²ˆí˜¸ (ìˆ«ì 4ìë¦¬)</label>
                        <input type="password" id="password-input" maxlength="4" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="ì˜ˆ: 1234">
                    </div>
                    <button id="login-btn" class="w-full text-white font-bold py-3 px-4 rounded-md btn-gradient">
                        ë¡œê·¸ì¸
                    </button>
                    <button id="signup-btn" class="w-full text-blue-700 font-bold py-3 px-4 rounded-md bg-blue-200 hover:bg-blue-300 transition duration-300">
                        íšŒì›ê°€ì…
                    </button>
                    <button id="admin-login-btn" class="w-full text-gray-700 font-bold py-2 px-4 rounded-md bg-gray-200 hover:bg-gray-300 transition duration-300 text-sm">
                        ê´€ë¦¬ì ë¡œê·¸ì¸
                    </button>
                </div>
            </div>

            <!-- ë§ˆë‹ˆë˜ ê²Œì„ ë³¸ë¬¸ (ë¡œê·¸ì¸ í›„ í‘œì‹œ) -->
            <div id="manito-game-section" class="hidden">
                <div id="user-info" class="text-center mb-6 p-3 bg-indigo-100 border border-indigo-200 rounded-lg text-indigo-800">
                    <p class="font-semibold">í™˜ì˜í•©ë‹ˆë‹¤! <span id="current-user-name" class="font-bold"></span> ì¹œêµ¬!</p>
                    <button id="logout-btn" class="mt-2 text-sm text-indigo-600 hover:underline">ë¡œê·¸ì•„ì›ƒ</button>
                </div>

                <!-- ê´€ë¦¬ì íŒ¨ë„ -->
                <div id="admin-panel" class="hidden mb-8 p-4 bg-red-100 border border-red-300 rounded-lg">
                    <h3 class="font-bold text-lg text-red-800 text-center mb-2">ê´€ë¦¬ì íŒ¨ë„</h3>
                    <p class="text-center text-red-700 mb-2">ë§ˆë‹ˆë˜ ì„ íƒ: <span id="selection-status" class="font-bold"></span></p>
                    <button id="toggle-selection-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md transition duration-300 mb-4">
                        ìƒíƒœ ë³€ê²½
                    </button>
                    <h4 class="font-bold text-md text-red-800 mb-2">í•™ìƒ ëª©ë¡ ë° ë¹„ë°€ë²ˆí˜¸</h4>
                    <ul id="user-list" class="space-y-2 max-h-60 overflow-y-auto bg-white p-3 rounded-md border border-red-200">
                        <!-- í•™ìƒ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </ul>
                </div>
                
                <div class="mb-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 class="font-semibold text-lg mb-2 text-gray-700">ë§ˆë‹ˆë˜ ì°¸ì—¬ ë°©ë²•</h3>
                    <ol class="list-decimal list-inside space-y-2 text-gray-600">
                        <li>ë§ˆë‹ˆë˜ë¥¼ ìœ„í•´ <span class="font-bold text-purple-600">ì†Œì†Œí•˜ê³  ì‘ì€ ì„ ë¬¼</span>ì„ ë¯¸ë¦¬ ì¤€ë¹„í•´ì£¼ì„¸ìš”.</li>
                        <li>ì•„ë˜ì— <span class="font-bold">ìì‹ ì„ ë‚˜íƒ€ë‚´ëŠ” í•œ ì¤„ ì„¤ëª…</span>ê³¼ <span class="font-bold">ì¢‹ì•„í•˜ëŠ” ê¸€ê·€</span>ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”. <br><span class="text-red-500 font-semibold">(â€» ë³¸ì¸ì˜ ì´ë¦„ì€ ì ˆëŒ€ë¡œ ë°íˆì‹œë©´ ì•ˆ ë¼ìš”!)</span></li>
                        <li>ë‹¤ë¥¸ ì¹œêµ¬ì˜ ê¸€ì„ ì½ê³  ë§ˆìŒì´ ê°€ëŠ” ê¸€ì„ ì„ íƒí•˜ë©´, ê·¸ ì¹œêµ¬ì˜ ë§ˆë‹ˆë˜ê°€ ë©ë‹ˆë‹¤. <br><span class="text-blue-600 font-semibold">(â€» ì„ íƒì€ ì„ ìƒë‹˜ì´ ê¸°ëŠ¥ì„ ì—° í›„ì— ê°€ëŠ¥í•©ë‹ˆë‹¤!)</span></li>
                    </ol>
                </div>
                
                <div id="manito-form-container" class="mb-8">
                    <div class="space-y-4">
                        <div>
                            <label for="introduction" class="block text-sm font-medium text-gray-700">ë‚˜ë¥¼ ì†Œê°œí•˜ëŠ” í•œ ì¤„ (ì´ë¦„ ì œì™¸)</label>
                            <input type="text" id="introduction" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ì˜ˆ: ì•„ì´ë“¤ê³¼ í•¨ê»˜ ì„±ì¥í•˜ëŠ” ê²ƒì„ ì¦ê¸°ëŠ” ì‚¬ëŒì…ë‹ˆë‹¤.">
                        </div>
                        <div>
                            <label for="quote" class="block text-sm font-medium text-gray-700">ì¢‹ì•„í•˜ëŠ” ê¸€ê·€ë‚˜ ëª…ì–¸</label>
                            <textarea id="quote" rows="3" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="ì˜ˆ: ë³„ì€ ë°”ë¼ë³´ëŠ” ìì—ê²Œ ë¹›ì„ ì¤€ë‹¤."></textarea>
                        </div>
                        <button id="submit-btn" class="w-full text-white font-bold py-3 px-4 rounded-md btn-gradient">
                            ì œì¶œí•˜ê¸°
                        </button>
                    </div>
                </div>

                <div>
                    <!-- ë‚´ê°€ ì„ íƒí•œ ë§ˆë‹ˆë˜ í‘œì‹œ ì˜ì—­ -->
                    <div id="my-manito-display" class="hidden mb-6 p-4 bg-teal-100 border border-teal-300 rounded-lg">
                        <h3 class="text-xl font-bold text-center text-teal-800 mb-2 font-playfair">âœ¨ ë‹¹ì‹ ì€ ì´ ì¹œêµ¬ì˜ ë¹„ë°€ ë§ˆë‹ˆë˜ì…ë‹ˆë‹¤ âœ¨</h3>
                        <div class="text-center bg-white p-3 rounded-md">
                            <p id="my-manito-target-name" class="text-lg font-bold text-indigo-700 mb-2"></p>
                            <p id="my-manito-introduction" class="text-sm text-gray-700 mb-2"></p>
                            <p id="my-manito-quote" class="font-serif text-lg italic text-teal-900"></p>
                        </div>
                    </div>

                    <h3 class="text-2xl font-playfair font-bold text-center mb-2 text-gray-800">ì¹œêµ¬ì˜ ëª…ì–¸ ì„ íƒí•˜ê¸°</h3>
                    <p class="text-center text-gray-500 mb-6">ë§ˆìŒì— ë“œëŠ” ê¸€ê·€ë¥¼ ì„ íƒí•´ ê·¸ ì¹œêµ¬ì˜ ë§ˆë‹ˆë˜ê°€ ë˜ì–´ì£¼ì„¸ìš”. (ì„ íƒì€ ë‹¨ í•œ ë²ˆ!)</p>
                    <div id="entries-list" class="grid md:grid-cols-2 gap-4">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì•Œë¦¼ìš© Modal -->
    <div id="modal" class="fixed inset-0 bg-gray-800 bg-opacity-60 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
        <div class="relative p-5 border w-full max-w-md shadow-lg rounded-2xl bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-bold text-gray-900" id="modal-title"></h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-600" id="modal-content"></p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-close" class="w-full px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-300">
                        í™•ì¸
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ìˆ˜ì •ìš© Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-800 bg-opacity-60 overflow-y-auto h-full w-full hidden z-50 flex items-center justify-center">
        <div class="relative p-6 border w-full max-w-lg shadow-lg rounded-2xl bg-white">
            <h3 class="text-xl font-bold text-gray-900 mb-4">ë‚´ ê¸€ ìˆ˜ì •í•˜ê¸°</h3>
            <div class="space-y-4">
                <div>
                    <label for="edit-introduction" class="block text-sm font-medium text-gray-700">ë‚˜ë¥¼ ì†Œê°œí•˜ëŠ” í•œ ì¤„</label>
                    <input type="text" id="edit-introduction" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="edit-quote" class="block text-sm font-medium text-gray-700">ì¢‹ì•„í•˜ëŠ” ê¸€ê·€ë‚˜ ëª…ì–¸</label>
                    <textarea id="edit-quote" rows="4" class="mt-1 block w-full px-4 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>
            </div>
            <div class="flex items-center justify-end mt-6 space-x-3">
                <button id="cancel-edit-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300 focus:outline-none">
                    ì·¨ì†Œ
                </button>
                <button id="save-edit-btn" class="px-4 py-2 bg-indigo-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-indigo-600 focus:outline-none">
                    ìˆ˜ì • ì™„ë£Œ
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, setDoc, deleteDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ===================================================================================
        // â˜…â˜…â˜… ì¤‘ìš” â˜…â˜…â˜… ì—¬ê¸°ì— ë³¸ì¸ì˜ Firebase ì„¤ì • ì •ë³´ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!
        // Firebase ì½˜ì†”ì—ì„œ 'í”„ë¡œì íŠ¸ ì„¤ì •' > 'ë‚´ ì•±'ì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    const firebaseConfig = {
  apiKey: "AIzaSyBLJ_rZaQeIKINyaluOrv341a4n67a1S0I",
  authDomain: "manito-e16bb.firebaseapp.com",
  projectId: "manito-e16bb",
  storageBucket: "manito-e16bb.firebasestorage.app",
  messagingSenderId: "554752517590",
  appId: "1:554752517590:web:bb9a29289714a0ac8c7077",
  measurementId: "G-0PTMJLKNMB"
};
        // ===================================================================================

        // ===================================================================================
        // â˜…â˜…â˜… ê´€ë¦¬ì ì„¤ì • â˜…â˜…â˜… ì—¬ê¸°ì— ê´€ë¦¬ì ê³„ì • ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”!
        // ì´ë©”ì¼ ì£¼ì†ŒëŠ” ì‹¤ì œ ì´ë©”ì¼ í˜•ì‹ì„ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤. (ì˜ˆ: admin@example.com)
        const ADMIN_EMAIL = "dbsdk0405@gmail.com"; 
        const ADMIN_PASSWORD = "admin"; // ê´€ë¦¬ì ë¡œê·¸ì¸ìš© ë¹„ë°€ë²ˆí˜¸
        // ===================================================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // --- DOM Elements ---
        const authSection = document.getElementById('auth-section');
        const manitoGameSection = document.getElementById('manito-game-section');
        const nameInput = document.getElementById('name-input');
        const passwordInput = document.getElementById('password-input');
        const loginBtn = document.getElementById('login-btn');
        const signupBtn = document.getElementById('signup-btn');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const currentUserNameSpan = document.getElementById('current-user-name');
        const logoutBtn = document.getElementById('logout-btn');

        const introductionInput = document.getElementById('introduction');
        const quoteInput = document.getElementById('quote');
        const submitBtn = document.getElementById('submit-btn');
        const entriesList = document.getElementById('entries-list');
        const manitoFormContainer = document.getElementById('manito-form-container');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalClose = document.getElementById('modal-close');
        const editModal = document.getElementById('edit-modal');
        const editIntroductionInput = document.getElementById('edit-introduction');
        const editQuoteInput = document.getElementById('edit-quote');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const adminPanel = document.getElementById('admin-panel');
        const selectionStatus = document.getElementById('selection-status');
        const toggleSelectionBtn = document.getElementById('toggle-selection-btn');
        const userList = document.getElementById('user-list');

        const myManitoDisplay = document.getElementById('my-manito-display');
        const myManitoTargetName = document.getElementById('my-manito-target-name');
        const myManitoIntroduction = document.getElementById('my-manito-introduction');
        const myManitoQuote = document.getElementById('my-manito-quote');


        // --- Global State ---
        let currentUser = null;
        let currentUserName = '';
        let currentUserUid = '';
        let currentEntries = []; // ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ì €ì¥í•  ë°°ì—´
        let userHasSubmitted = false;
        let userHasSelected = false;
        let isSelectionOpen = false;
        let currentEditingDocId = null;

        // --- Functions ---
        function showModal(title, content) {
            modalTitle.textContent = title;
            modalContent.textContent = content;
            modal.classList.remove('hidden');
        }

        modalClose.addEventListener('click', () => modal.classList.add('hidden'));

        // ë¹„ë°€ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬ (ìˆ«ì 4ìë¦¬)
        function isValidPassword(password) {
            return /^\d{4}$/.test(password);
        }

        // ë¡œê·¸ì¸/íšŒì›ê°€ì… ì²˜ë¦¬
        loginBtn.addEventListener('click', async () => {
            const name = nameInput.value.trim();
            const password = passwordInput.value.trim();
            if (!name || !password) {
                showModal('ì…ë ¥ ì˜¤ë¥˜', 'ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (!isValidPassword(password)) {
                showModal('ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìˆ«ì 4ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            // ì‚¬ìš©ìë³„ ê³ ìœ  ì´ë©”ì¼ ìƒì„± (Firebase Auth ì´ë©”ì¼ í˜•ì‹ ìš”êµ¬ì‚¬í•­)
            const email = `${name.replace(/\s+/g, '')}@manito.com`;

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    showModal('ë¡œê·¸ì¸ ì‹¤íŒ¨', 'ì´ë¦„ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                } else if (error.code === 'auth/wrong-password') {
                    showModal('ë¡œê·¸ì¸ ì‹¤íŒ¨', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                } else {
                    showModal('ë¡œê·¸ì¸ ì˜¤ë¥˜', `ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                }
            }
        });

        signupBtn.addEventListener('click', async () => {
            const name = nameInput.value.trim();
            const password = passwordInput.value.trim();
            if (!name || !password) {
                showModal('ì…ë ¥ ì˜¤ë¥˜', 'ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (!isValidPassword(password)) {
                showModal('ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ëŠ” ìˆ«ì 4ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            const email = `${name.replace(/\s+/g, '')}@manito.com`;

            try {
                // ì´ë¯¸ ê°™ì€ ì´ë¦„ìœ¼ë¡œ ê°€ì…ëœ ì‚¬ìš©ìê°€ ìˆëŠ”ì§€ í™•ì¸
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("name", "==", name));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    showModal('íšŒì›ê°€ì… ì‹¤íŒ¨', 'ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤. ë‹¤ë¥¸ ì´ë¦„ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, { displayName: name }); // displayName ì„¤ì •
                
                // Firestoreì— ì‚¬ìš©ì ì •ë³´ ì €ì¥ (ë¹„ë°€ë²ˆí˜¸ë„ ì €ì¥í•˜ì—¬ ê´€ë¦¬ì ì—´ëŒ ê°€ëŠ¥)
                await setDoc(doc(db, "users", userCredential.user.uid), {
                    name: name,
                    password: password, // ê´€ë¦¬ì ì—´ëŒì„ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ ì €ì¥ (ë³´ì•ˆìƒ ê¶Œì¥ë˜ì§€ëŠ” ì•Šì§€ë§Œ ìš”ì²­ì— ë”°ë¦„)
                    uid: userCredential.user.uid,
                    createdAt: serverTimestamp()
                });

                showModal('íšŒì›ê°€ì… ì„±ê³µ', 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ë©ë‹ˆë‹¤.');
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    showModal('íšŒì›ê°€ì… ì‹¤íŒ¨', 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë¦„(ì´ë©”ì¼)ì…ë‹ˆë‹¤. ë¡œê·¸ì¸í•˜ê±°ë‚˜ ë‹¤ë¥¸ ì´ë¦„ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                } else {
                    showModal('íšŒì›ê°€ì… ì˜¤ë¥˜', `íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                }
            }
        });

        adminLoginBtn.addEventListener('click', async () => {
            try {
                await signInWithEmailAndPassword(auth, ADMIN_EMAIL, ADMIN_PASSWORD);
            } catch (error) {
                showModal('ê´€ë¦¬ì ë¡œê·¸ì¸ ì‹¤íŒ¨', 'ê´€ë¦¬ì ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await signOut(auth);
        });


        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                currentUserUid = user.uid;
                currentUserName = user.displayName || user.email.split('@')[0]; // displayName ë˜ëŠ” ì´ë©”ì¼ì—ì„œ ì´ë¦„ ì¶”ì¶œ
                currentUserNameSpan.textContent = currentUserName;

                authSection.classList.add('hidden');
                manitoGameSection.classList.remove('hidden');

                if (currentUser.email === ADMIN_EMAIL) {
                    adminPanel.classList.remove('hidden');
                    setupAdminControlsListener();
                    setupUserListListener(); // ê´€ë¦¬ìì¼ ê²½ìš° í•™ìƒ ëª©ë¡ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                } else {
                    adminPanel.classList.add('hidden');
                }
                setupEntriesListener();
            } else {
                currentUser = null;
                currentUserUid = '';
                currentUserName = '';
                authSection.classList.remove('hidden');
                manitoGameSection.classList.add('hidden');
                adminPanel.classList.add('hidden'); // ë¡œê·¸ì•„ì›ƒ ì‹œ ê´€ë¦¬ì íŒ¨ë„ ìˆ¨ê¹€
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                nameInput.value = '';
                passwordInput.value = '';
            }
        });

        submitBtn.addEventListener('click', async () => {
            if (!currentUser || userHasSubmitted) {
                showModal('ì•Œë¦¼', userHasSubmitted ? 'ì´ë¯¸ ì œì¶œí•˜ì…¨ìŠµë‹ˆë‹¤.' : 'ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            const introduction = introductionInput.value.trim();
            const quote = quoteInput.value.trim();
            if (!introduction || !quote) {
                showModal('ì…ë ¥ ì˜¤ë¥˜', 'ëª¨ë“  í•„ë“œë¥¼ ì±„ì›Œì£¼ì„¸ìš”.');
                return;
            }
            submitBtn.disabled = true;
            submitBtn.textContent = 'ì œì¶œ ì¤‘...';
            try {
                await addDoc(collection(db, "manito-entries"), {
                    introduction, quote,
                    authorId: currentUserUid,
                    authorName: currentUserName, // ì œì¶œì ì´ë¦„ ì €ì¥
                    selectedBy: null,
                    selectedByName: null, // ì„ íƒí•œ ì‚¬ëŒ ì´ë¦„ ì €ì¥
                    timestamp: serverTimestamp()
                });
                showModal('ì„±ê³µ', 'ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                showModal('ì˜¤ë¥˜', 'ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ì œì¶œí•˜ê¸°';
            }
        });
        
        function setupAdminControlsListener() {
            onSnapshot(doc(db, "admin-controls", "settings"), (docSnap) => {
                isSelectionOpen = docSnap.exists() ? docSnap.data().selectionOpen : false;
                updateUIBasedOnSelectionState();
            });
        }

        function setupUserListListener() {
            onSnapshot(collection(db, "users"), (snapshot) => {
                userList.innerHTML = '';
                snapshot.docs.forEach(docSnap => {
                    const userData = docSnap.data();
                    const listItem = document.createElement('li');
                    listItem.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-md border border-gray-100';
                    listItem.innerHTML = `
                        <span class="font-medium text-gray-700">${userData.name}</span>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">PW: ${userData.password}</span>
                            <button class="reset-password-btn text-red-500 hover:text-red-700 text-sm" data-uid="${userData.uid}" data-name="${userData.name}">ì´ˆê¸°í™”</button>
                        </div>
                    `;
                    userList.appendChild(listItem);
                });

                // ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                userList.querySelectorAll('.reset-password-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const targetUid = e.target.dataset.uid;
                        const targetName = e.target.dataset.name;
                        if (confirm(`${targetName} í•™ìƒì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ '1234'ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                            const userDocRef = doc(db, "users", targetUid);
                            const userEmail = `${targetName.replace(/\s+/g, '')}@manito.com`;

                            try {
                                // Firebase Auth ë¹„ë°€ë²ˆí˜¸ ì—…ë°ì´íŠ¸ (ì´ë©”ì¼ë¡œ ë³€ê²½)
                                const usersRef = await getDocs(collection(db, "users"));
                                const targetUserDoc = usersRef.docs.find(d => d.data().uid === targetUid);
                                if (targetUserDoc) {
                                    // Firebase Admin SDKë¥¼ ì‚¬ìš©í•´ì•¼ í•˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” ì§ì ‘ ì‚¬ìš©ìì—ê²Œ ì´ë©”ì¼ì„ ë³´ë‚´ì„œ ì´ˆê¸°í™”í•˜ë„ë¡ ì•ˆë‚´í•˜ëŠ” ê²ƒì´ í˜„ì‹¤ì ì…ë‹ˆë‹¤.
                                    // ì›¹ í´ë¼ì´ì–¸íŠ¸ SDKë¡œëŠ” ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì§ì ‘ ë³€ê²½í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                                    // ì—¬ê¸°ì„œëŠ” Firestoreì— ì €ì¥ëœ ë¹„ë°€ë²ˆí˜¸ë§Œ '1234'ë¡œ ì—…ë°ì´íŠ¸í•˜ê³ ,
                                    // ì‹¤ì œ Auth ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”ëŠ” ê´€ë¦¬ìê°€ Firebase ì½˜ì†”ì—ì„œ í•˜ê±°ë‚˜, 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ ë³´ë‚´ê¸°' ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
                                    // ë³¸ ìš”ì²­ì—ì„œëŠ” Firestoreì— ì €ì¥ëœ ë¹„ë°€ë²ˆí˜¸ë§Œ ì´ˆê¸°í™”í•˜ëŠ” ê²ƒìœ¼ë¡œ ê°„ì£¼í•©ë‹ˆë‹¤.
                                    await updateDoc(userDocRef, { password: '1234' });
                                    showModal('ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”', `${targetName} í•™ìƒì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ '1234'ë¡œ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.`);
                                } else {
                                     showModal('ì˜¤ë¥˜', 'ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                                }
                            } catch (error) {
                                showModal('ì˜¤ë¥˜', `ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                            }
                        }
                    });
                });
            });
        }


        function setupEntriesListener() {
            if (!currentUser) return;
            onSnapshot(collection(db, "manito-entries"), async (snapshot) => {
                const entries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                entries.sort((a, b) => (a.timestamp?.toMillis() || 0) - (b.timestamp?.toMillis() || 0));
                
                currentEntries = entries; // ì‹¤ì‹œê°„ ë°ì´í„°ë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥

                userHasSubmitted = entries.some(entry => entry.authorId === currentUserUid);
                userHasSelected = entries.some(entry => entry.selectedBy === currentUserUid);

                if (userHasSubmitted) {
                    manitoFormContainer.style.display = 'none';
                } else {
                    manitoFormContainer.style.display = 'block';
                }
                
                const mySelection = entries.find(entry => entry.selectedBy === currentUserUid);

                if (mySelection) {
                    myManitoTargetName.textContent = mySelection.authorName + " ì¹œêµ¬";
                    myManitoIntroduction.textContent = `"${mySelection.introduction}"`;
                    myManitoQuote.textContent = `"${mySelection.quote}"`;
                    myManitoDisplay.classList.remove('hidden');
                } else {
                    myManitoDisplay.classList.add('hidden');
                }

                renderEntries(entries);
            });
        }
        
        function updateUIBasedOnSelectionState() {
            if (currentUser && currentUser.email === ADMIN_EMAIL) {
                selectionStatus.textContent = isSelectionOpen ? 'ì§„í–‰ ì¤‘' : 'ë§ˆê°';
                toggleSelectionBtn.textContent = isSelectionOpen ? 'ë§ˆë‹ˆë˜ ì„ íƒ ë§ˆê°í•˜ê¸°' : 'ë§ˆë‹ˆë˜ ì„ íƒ ì‹œì‘í•˜ê¸°';
            }
            renderEntries(currentEntries); // ì €ì¥ëœ ë°ì´í„°ë¡œ í™”ë©´ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        }
        
        function createEntryCard(entry) {
            const card = document.createElement('div');
            card.className = 'p-4 bg-white rounded-xl shadow-lg border border-gray-200 flex flex-col justify-between transition-transform hover:scale-105';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex-grow';
            contentDiv.innerHTML = `<p class="text-sm text-gray-500 mb-2">"${entry.introduction}"</p><p class="font-serif text-lg italic text-gray-800">"${entry.quote}"</p>`;
            card.appendChild(contentDiv);
            
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'mt-4 pt-4 border-t border-gray-100';

            const isAdmin = currentUser && currentUser.email === ADMIN_EMAIL;

            if (entry.authorId === currentUserUid) { // ë‚´ê°€ ì“´ ê¸€
                const canEdit = (!isSelectionOpen && !entry.selectedBy) || isAdmin;
                if (canEdit) {
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'ìˆ˜ì •';
                    editBtn.className = 'w-1/2 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-l-md transition duration-300';
                    editBtn.onclick = () => openEditModal(entry);
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'ì‚­ì œ';
                    deleteBtn.className = 'w-1/2 bg-red-500 hover
